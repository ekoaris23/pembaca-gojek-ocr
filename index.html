<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembaca Orderan Gojek</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        input[type="file"] {
            display: block;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        button {
            background-color: #008000;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #006400;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loading {
            margin-top: 20px;
            color: #666;
            font-style: italic;
            font-size: 14px;
        }
        #result-container {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 20px;
            display: none;
        }
        h3 {
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #eee;
            text-align: left;
            font-size: 14px;
        }
        th {
            background-color: #fafafa;
            font-weight: bold;
        }
        .error {
            color: #d9534f;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Pembaca Orderan Gojek</h1>
    <p>Unggah tangkapan layar orderan Gojek Anda untuk memprosesnya menjadi data tabel menggunakan Gemini.</p>
    
    <input type="file" id="imageInput" accept="image/*">
    <button id="processBtn" onclick="processImage()" disabled>Proses Gambar</button>
    
    <div id="status" class="loading">Model siap. Silakan unggah gambar.</div>
    
    <div id="result-container">
        <h3>Hasil Ekstraksi Data</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Informasi</th>
                    <th>Detail</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data akan diisi di sini oleh JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const imageInput = document.getElementById('imageInput');
    const processBtn = document.getElementById('processBtn');
    const statusDiv = document.getElementById('status');
    const resultContainer = document.getElementById('result-container');
    const dataTableBody = document.querySelector('#dataTable tbody');

    // Aktifkan tombol saat file dipilih
    imageInput.addEventListener('change', () => {
        processBtn.disabled = !imageInput.files[0];
    });

    // Helper function to convert file to Base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    async function processImage() {
        const file = imageInput.files[0];
        if (!file) {
            statusDiv.textContent = 'Silakan pilih gambar terlebih dahulu.';
            statusDiv.classList.add('error');
            return;
        }
        
        processBtn.disabled = true;
        resultContainer.style.display = 'none';
        dataTableBody.innerHTML = '';
        statusDiv.classList.remove('error');
        statusDiv.textContent = 'Memproses gambar dengan Gemini...';

        try {
            const base64ImageData = await fileToBase64(file);
            const prompt = `Ekstrak semua informasi penting dari tangkapan layar orderan Gojek ini. Pastikan Anda mendapatkan data untuk ID Transaksi, Tanggal Selesai, Waktu Ditugaskan, Waktu Jemput, Waktu Selesai, Jarak, Titik Jemput, Tujuan, Total Pendapatan Mitra, Pendapatan dari pelanggan, dan Potongan/biaya. Berikan hasilnya dalam format JSON yang terstruktur.`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: "image/jpeg",
                                data: base64ImageData
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "idTransaksi": { "type": "STRING" },
                            "tanggalSelesai": { "type": "STRING" },
                            "waktuDitugaskan": { "type": "STRING" },
                            "waktuJemput": { "type": "STRING" },
                            "waktuSelesai": { "type": "STRING" },
                            "jarak": { "type": "STRING" },
                            "titikJemput": { "type": "STRING" },
                            "tujuan": { "type": "STRING" },
                            "totalPendapatan": { "type": "STRING" },
                            "pendapatanPelanggan": { "type": "STRING" },
                            "potonganBiaya": { "type": "STRING" }
                        }
                    }
                }
            };

            const apiKey = ""; // Disediakan oleh Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                
                const jsonText = result.candidates[0].content.parts[0].text;
                const extractedData = JSON.parse(jsonText);

                // Buat mapping untuk nama yang lebih mudah dibaca di tabel
                const displayNames = {
                    idTransaksi: 'ID Transaksi',
                    tanggalSelesai: 'Tanggal Selesai',
                    waktuDitugaskan: 'Waktu Ditugaskan',
                    waktuJemput: 'Waktu Jemput',
                    waktuSelesai: 'Waktu Selesai',
                    jarak: 'Jarak',
                    titikJemput: 'Titik Jemput',
                    tujuan: 'Tujuan',
                    totalPendapatan: 'Total Pendapatan Mitra',
                    pendapatanPelanggan: 'Pendapatan dari Pelanggan',
                    potonganBiaya: 'Potongan/Biaya'
                };

                let dataFound = false;
                for (const key in extractedData) {
                    if (extractedData[key]) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${displayNames[key] || key}</td><td>${extractedData[key]}</td>`;
                        dataTableBody.appendChild(row);
                        dataFound = true;
                    }
                }

                if (dataFound) {
                    statusDiv.textContent = 'Data berhasil diekstrak!';
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="2" style="text-align: center;">Tidak ada data yang berhasil ditemukan.</td>`;
                    dataTableBody.appendChild(row);
                    statusDiv.textContent = 'Tidak ada data yang berhasil diekstrak. Mohon coba gambar lain.';
                }
                
                resultContainer.style.display = 'block';

            } else {
                statusDiv.textContent = 'Gagal mengekstrak data. Respons dari Gemini tidak valid.';
                statusDiv.classList.add('error');
            }
            
        } catch (error) {
            statusDiv.textContent = `Terjadi kesalahan saat memproses gambar: ${error.message}`;
            statusDiv.classList.add('error');
            console.error(error);
        } finally {
            processBtn.disabled = false;
        }
    }
</script>

</body>
</html>